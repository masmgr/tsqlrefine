name: release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    name: Build and create release
    runs-on: ubuntu-latest

    env:
      DOTNET_NOLOGO: true
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Setup .NET (global.json)
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4
        with:
          global-json-file: global.json

      - name: Extract version from tag
        id: extract_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Version: $TAG_NAME"

      - name: Restore
        run: dotnet restore src/TsqlRefine.sln

      - name: Build
        run: dotnet build src/TsqlRefine.sln -c Release --no-restore /p:VersionSuffix=

      - name: Test
        run: dotnet test src/TsqlRefine.sln -c Release --no-build

      - name: Pack
        run: |
          dotnet pack src/TsqlRefine.Cli/TsqlRefine.Cli.csproj -c Release --no-build /p:VersionSuffix=
          dotnet pack src/TsqlRefine.PluginSdk/TsqlRefine.PluginSdk.csproj -c Release --no-build /p:VersionSuffix=

      - name: Generate SHA256 checksums
        run: |
          cd nupkg
          sha256sum *.nupkg *.snupkg > checksums.sha256
          echo "Generated checksums:"
          cat checksums.sha256

      - name: Create GitHub Release
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v1
        with:
          name: Release ${{ steps.extract_version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(steps.extract_version.outputs.VERSION, '-') }}
          files: |
            nupkg/*.nupkg
            nupkg/*.snupkg
            nupkg/checksums.sha256
          body: |
            ## Installation

            Install as a .NET global tool:

            ```bash
            dotnet tool install --global TsqlRefine --version ${{ steps.extract_version.outputs.VERSION }}
            ```

            Or update an existing installation:

            ```bash
            dotnet tool update --global TsqlRefine --version ${{ steps.extract_version.outputs.VERSION }}
            ```

            ## Usage

            ```bash
            tsqlrefine --help
            ```

            See the [README](https://github.com/${{ github.repository }}/blob/main/README.md) for full documentation.

            ## Verify Release Integrity

            SHA256 checksums are attached as `checksums.sha256`.

            ```bash
            sha256sum -c checksums.sha256
            ```

  publish:
    name: Publish to NuGet
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-alpha') && !contains(github.ref, '-beta')

    env:
      DOTNET_NOLOGO: true
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup .NET (global.json)
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4
        with:
          global-json-file: global.json

      - name: Restore
        run: dotnet restore src/TsqlRefine.sln

      - name: Build
        run: dotnet build src/TsqlRefine.sln -c Release --no-restore /p:VersionSuffix=

      - name: Pack
        run: |
          dotnet pack src/TsqlRefine.Cli/TsqlRefine.Cli.csproj -c Release --no-build /p:VersionSuffix=
          dotnet pack src/TsqlRefine.PluginSdk/TsqlRefine.PluginSdk.csproj -c Release --no-build /p:VersionSuffix=

      - name: Push to NuGet.org
        run: dotnet nuget push nupkg/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
