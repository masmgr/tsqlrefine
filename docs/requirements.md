## 1. 背景・目的

### 背景

* SQL Server / Transact-SQL（T-SQL）を扱うソースコードに対して、**実行するまで見つからない問題**がある。
* 開発時点で危険コードや潜在不具合を検出し、品質と開発効率を上げたい。
* 併せて、SQLの見た目（大文字小文字、最低限の整形）を揃えて可読性を上げたい。

### 目的

* **Lint（基本ルール）**により危険な書き方を早期に検出する
* **高度Lint（危険コードチェック・静的解析）**により、実行前に不具合可能性を検出する
* **フォーマット**により可読性を上げる（ただし構造を崩さない“最小限整形”）
* 可能な範囲で**オートフィックス**（意味・ロジック不変）を提供する
* CLI/VSCode から使えるようにし、CIにも組み込み可能にする

---

## 2. 対象とスコープ

### 対象

* SQL Server の T-SQL
* ソースコード上の SQL（ファイル、標準入力、VSCode等からの入力）

### 提供する機能領域

1. Lint（構文・スタイル・安全性）
2. 静的解析（実行時に顕在化しがちな問題の予兆検出）
3. フォーマット（最小限）
4. オートフィックス（限定的）

---

## 3. 機能要件

### 3.1 Lint（基本）

* T-SQL に対するルールベースのLint
* ルール違反を検出し、位置情報（行/列）・メッセージ・重要度を返す

例（カテゴリ案）

* **Security**: SQLインジェクション誘発パターン、危険な動的SQLなど
* **Correctness**: 曖昧な参照、NULLまわりの危険、暗黙変換の罠、など
* **Performance**: SARGableでない条件、不要なSELECT * など
* **Maintainability**: 可読性・保守性を落とすパターン（過度なネスト等）
* **Style**: 命名や表記ゆれ

> ※ルール自体は後で増えるので、この時点では「カテゴリ化・拡張可能」が要件の中心。

---

### 3.2 高度Lint / 静的解析

* 「実行するまで検出されにくい問題」を静的に推定して警告できること
* 解析基盤として **AST（構文木）＋ルール＋場合によりデータフロー的推論** を想定
* 解析は “SQL Server 実行環境が無くても” 一定レベル動く（ただし精度限界は許容）

検出したい問題（方向性）

* 実行時エラーの起点になりやすい書き方
* 期待と違う意味になりやすい書き方（暗黙変換、スコープ誤解、曖昧列など）
* 危険操作（DROP/TRUNCATE/広範囲UPDATE/DELETE等）を「条件不十分」などで検知

---

### 3.3 フォーマット（最小限整形）

「構造が大きく崩れない」ことが重要条件。やることは最低限に限定。

必須（あなたの話から確定）

* キーワードの大文字小文字統一（例: SELECT/Select/select を統一）
* 識別子（列名等）の大文字小文字統一（ポリシーに基づく）
* **予約語を列名などに使っている場合にエスケープ**（例: [Order] など）
* カンマ付け等の必要最低限の整形

制約

* 大規模な再レイアウトはしない（段組み変更、全面改行、並べ替え等は避ける）
* 「できるだけ元の見た目を保持」しつつ、表記ゆれを消す方向

---

### 3.4 オートフィックス

* 意味/ロジックが変わらない範囲のみ自動修正
* ルールごとに **Fix提供可否** を持つ
* 適用モード例：

  * `--fix`（安全な修正のみ）
  * `--fix-suggest`（提案のみ、適用はユーザー）

---

### 3.5 入出力・統合（CLI / VSCode / CI）

* CLIツールとして動作する
* VSCode等エディタ統合を想定し、**標準入力/標準出力**に対応

  * stdin: SQLテキスト
  * stdout: 診断結果（JSON等）または整形後テキスト
* CI向けに終了コードを使い分け

  * 例：違反あり=非0、解析エラー=別コード、など

---

## 4. 拡張性要件（プラグイン）

### プラグインで拡張できる対象

* Lintルール追加
* 静的解析ルール追加
* フォーマット処理の追加/差し替え（ただし“最小限”ポリシーに沿わせる）
* 診断結果の出力形式追加（例: SARIF、JUnit、独自）

### 必要な提供物

* プラグインを読み込むための **インターフェース（API契約）**
* バージョニング/互換性方針（破壊的変更の扱い）
* プラグインの安全策（クラッシュ隔離、例外扱い、ロード失敗時の挙動）

---

## 5. システム構成・リポジトリ/パッケージ

### 構成（3つの成果物）

1. **クラスライブラリ（Core SDK）**

   * 解析エンジン、AST、ルール実行、フォーマット、共通モデル
2. **コマンドラインツール（CLI）**

   * 入出力、設定、実行モード、終了コード、レポート出力
3. **プラグイン用インターフェース/SDK（Plugin SDK）**

   * プラグイン契約、サンプル、テンプレ、互換性

### リポジトリ

* 1つのリポジトリ内で3プロジェクトを管理
* それぞれ独立にビルドして **別パッケージとして配布**できる
* リリース時に一括でビルド/パッケージ作成可能

---

## 6. 設定要件（ルール/カテゴリ/フォーマット）

### 課題

* ルールが増えると設定が破綻しやすい（細かすぎて管理不能）

### 要件

* 設定ファイルでルールを制御できる
* ルール個別ON/OFFだけでなく、

  * **カテゴリ単位**でON/OFFやレベル設定できる
  * **最低限プリセット**（例: “recommended”, “strict”, “security-only” など）を提供できる
* フォーマット設定はLint設定と分離して持てる

  * 「どこまでフォーマットするか」を明示（=最小限ポリシーの範囲内で）

---

## 7. 非機能要件（最低限）

* **信頼性**：解析不能でも落ちずに、エラーとして返す
* **再現性**：同じ入力・同じ設定なら同じ結果
* **速度**：開発時に常用できる実行速度（VSCode連携で致命的に遅いのはNG）
* **可搬性**：CLIはCIやローカルで動く
* **拡張性**：ルール・出力・フォーマット機能を追加しやすい構造

---

## 8. 実行モード案（CLIの仕様として固めやすい）

* `lint`：診断のみ（標準出力=レポート）
* `format`：整形のみ（標準出力=整形後SQL）
* `check`：lint + 解析（危険コード・静的解析含む）
* `fix`：安全な範囲で自動修正（差分表示オプションもあり）

---

## 9. 用語（このプロジェクト内での定義）

* **Lint**：主にルールベースの静的チェック（構文/規約/危険パターン）
* **静的解析**：AST以上の情報（スコープ、依存、推論）を使った高度チェック
* **フォーマット**：可読性のための表記統一・最小整形（大規模整形はしない）
* **オートフィックス**：意味が変わらないと保証できる修正のみ


次にやると一気に設計が進むのは、**(A) ルールカテゴリ案と優先順位**、**(B) CLIの入出力仕様（JSON形式/終了コード）**、**(C) プラグインAPIの最小契約（Rule/Formatter/Reporter）** の3つ。

もし続けるなら、あなたの想定に寄せて「初期リリース（MVP）」を切るために、**最初に入れるルール10〜20個**と**フォーマットの最小セット**をこちらで叩き台にして出すよ。
