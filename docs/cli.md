# CLI Specification (I/O / JSON / Exit Codes)

This document defines the CLI specification for `tsqlrefine`.

---

## 1. Command Structure

Basic format:

```
tsqlrefine <command> [options] [paths...]
```

- If `<command>` is omitted, `lint` is assumed
- `paths...` can be a mix of `file.sql` / `dir`
- Standard input is accepted via `-` or `--stdin` (pure SQL only)

Commands:

| Command | Description |
|----------|------|
| `lint` | Rule-based diagnostics (static analysis) **[default]** |
| `format` | Minimal formatting only (outputs SQL text) |
| `fix` | Diagnostics + auto-fix within "safe scope" |
| `init` | Generate default configuration file |
| `print-config` | Output effective configuration in JSON format |
| `list-rules` | List available rules (loaded) |
| `list-plugins` | List loaded plugins (Rule plugins only) |

---

## 2. Options

### 2.1 Global Options

Available for all commands:

| Option | Description |
|------------|------|
| `-c, --config <path>` | Path to configuration file (overrides default discovery) |
| `-h, -?, --help` | Display help (auto-generated by System.CommandLine) |
| `--version` | Display version number |

> **Note**: Help is auto-generated by System.CommandLine 2.0.0. Each subcommand's help displays only the options available for that command.

### 2.2 Command-Specific Options

Options available for each command:

#### lint

```
tsqlrefine lint [options] [paths...]
```

| Option | Description |
|------------|------|
| `-g, --ignorelist <path>` | Ignore pattern file |
| `--detect-encoding` | Auto-detect input encoding |
| `--stdin` | Read from standard input |
| `--output <text\|json>` | Output format (default: `text`) |
| `--compat-level <100-160>` | SQL Server compatibility level |
| `--severity <error\|warning\|info\|hint>` | Minimum severity filter |
| `--preset <name>` | Preset selection |
| `--ruleset <path>` | Custom ruleset file |

#### format

```
tsqlrefine format [options] [paths...]
```

| Option | Description |
|------------|------|
| `-g, --ignorelist <path>` | Ignore pattern file |
| `--detect-encoding` | Auto-detect input encoding |
| `--stdin` | Read from standard input |
| `--output <text\|json>` | Output format (default: `text`) |
| `--compat-level <100-160>` | SQL Server compatibility level |
| `--indent-style <tabs\|spaces>` | Indentation type |
| `--indent-size <n>` | Indentation width |

> **Note**: When files are specified, formatted results are automatically written to the files. When using standard input (`--stdin`), results are output to stdout.

#### fix

```
tsqlrefine fix [options] [paths...]
```

| Option | Description |
|------------|------|
| `-g, --ignorelist <path>` | Ignore pattern file |
| `--detect-encoding` | Auto-detect input encoding |
| `--stdin` | Read from standard input |
| `--output <text\|json>` | Output format (default: `text`) |
| `--compat-level <100-160>` | SQL Server compatibility level |
| `--severity <error\|warning\|info\|hint>` | Minimum severity filter |
| `--preset <name>` | Preset selection |
| `--ruleset <path>` | Custom ruleset file |
| `--rule <id>` | Rule ID to apply |

> **Note**: When files are specified, fixed results are automatically written to the files. When using standard input (`--stdin`), results are output to stdout.

#### init

```
tsqlrefine init
```

No options. Generates `tsqlrefine.json` and `tsqlrefine.ignore`.

#### print-config

```
tsqlrefine print-config [options]
```

| Option | Description |
|------------|------|
| `--output <text\|json>` | Output format (default: `text`) |

#### list-rules

```
tsqlrefine list-rules [options]
```

| Option | Description |
|------------|------|
| `--output <text\|json>` | Output format (default: `text`) |

#### list-plugins

```
tsqlrefine list-plugins [options]
```

| Option | Description |
|------------|------|
| `--output <text\|json>` | Output format (default: `text`) |
| `--verbose` | Display detailed information |

### 2.3 Option Details

#### Preset (`--preset`)

| Preset | Description |
|------------|------|
| `recommended` | Balanced for production use (default) |
| `strict` | Maximum enforcement |
| `pragmatic` | Production minimum (bug and data loss prevention) |
| `security-only` | Security and critical safety only |

#### Encoding Detection (`--detect-encoding`)

- BOM takes priority. If no BOM, estimation via `UTF.Unknown`
- Without `--detect-encoding`, **reading** interprets as UTF-8
- For `format` / `fix`, input file encoding (including BOM presence) is preserved regardless of `--detect-encoding`

#### Formatting

- Respects `.editorconfig` `indent_style` / `indent_size` (`*.sql` only)
- `--indent-style` / `--indent-size` take precedence over `.editorconfig`
- Invariant regions: **comments / strings / line breaks within parentheses are not modified**

#### fix / format Command Output

- File input: results are automatically written to the file
- `--stdin` input: results are output to stdout
- With `--output json`: only diagnostic results are output

---

## 3. Text Output Format

For `--output text` (default), diagnostics are output in the following format:

```
<filepath>:<line>:<column>: <severity>: <message> (<rule-id>)
```

Example:

```
file.sql:1:8: Warning: Avoid SELECT *; explicitly list required columns. (avoid-select-star)
file.sql:1:15: Warning: Table reference 'users' should include schema qualification. (semantic/schema-qualify)
```

- `<filepath>`: File path (`<stdin>` for stdin)
- `<line>`: Line number (1-based)
- `<column>`: Column number (1-based)
- `<severity>`: `Error` / `Warning` / `Information` / `Hint`
- `<message>`: Diagnostic message
- `<rule-id>`: Rule ID

This format is similar to ESLint / GCC / rustc and is recognized as clickable links in many editors and IDEs.

---

## 4. JSON Output Specification (Diagnostics)

Based on VSCode `Diagnostic` compatible format, bundled by file.

### 4.1 Top Level

```ts
interface LintResult {
  tool: "tsqlrefine";
  version: string;
  command: "lint" | "format" | "fix";
  files: FileResult[];
}

interface FileResult {
  filePath: string;              // "<stdin>" for stdin
  diagnostics: Diagnostic[];
}
```

### 4.2 Diagnostic (0-based)

```ts
interface Diagnostic {
  range: Range;
  severity?: DiagnosticSeverity; // defaults to rule's defaultSeverity
  code?: number | string;        // Rule ID (e.g., "semantic/undefined-alias")
  source?: string;               // "tsqlrefine"
  message: string;
  tags?: DiagnosticTag[];
  data?: {
    ruleId?: string;
    category?: string;
    fixable?: boolean;
  };
}

interface Range {
  start: Position;
  end: Position;
}

interface Position {
  line: number;      // 0-based
  character: number; // 0-based
}

enum DiagnosticSeverity {
  Error = 1,
  Warning = 2,
  Information = 3,
  Hint = 4
}

enum DiagnosticTag {
  Unnecessary = 1,
  Deprecated = 2
}
```

---

## 5. Exit Codes

Fixed exit codes by result type for easy CI handling.

- `0`: Success (0 diagnostics, or 0 after `--severity` filter)
- `1`: Rule violations found (diagnostics present)
- `2`: Parse error (unparseable, `GO` split failure, etc.)
- `3`: Configuration error (config/ignore load failure, invalid compatibility level, etc.)
- `4`: Runtime exception (internal error)

For `format`/`fix` with `--write`, the same rules apply (if violations remain after fixes, exit code is `1`).
