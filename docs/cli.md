# CLI Specification (I/O / JSON / Exit Codes)

This document defines the CLI specification for `tsqlrefine`.

---

## 1. Command Structure

Basic format:

```
tsqlrefine <command> [options] [paths...]
```

- If `<command>` is omitted, `lint` is assumed
- `paths...` can be a mix of `file.sql` / `dir`
- Standard input is accepted via `-` or `--stdin` (pure SQL only)

Commands:

| Command | Description |
|----------|------|
| `lint` | Rule-based diagnostics (static analysis) **[default]** |
| `format` | Minimal formatting only (outputs SQL text) |
| `fix` | Diagnostics + auto-fix within "safe scope" |
| `init` | Generate default configuration file |
| `print-config` | Output effective configuration in JSON format |
| `print-format-config` | Output effective formatting options |
| `list-rules` | List available rules (loaded) |
| `list-plugins` | List loaded plugins (Rule plugins only) |

---

## 2. Options

### 2.1 Global Options

Available for all commands:

| Option | Description |
|------------|------|
| `-c, --config <path>` | Path to configuration file (overrides default discovery) |
| `--utf8` | Set console encoding to UTF-8 (stdin and stdout) |
| `-h, -?, --help` | Display help (auto-generated by System.CommandLine) |
| `--version` | Display version number |

> **Note**: Help is auto-generated by System.CommandLine 2.0.0. Each subcommand's help displays only the options available for that command.

### 2.2 Command-Specific Options

Options available for each command:

#### lint

```
tsqlrefine lint [options] [paths...]
```

| Option | Description |
|------------|------|
| `-g, --ignorelist <path>` | Ignore pattern file |
| `--detect-encoding` | Auto-detect input encoding |
| `--stdin` | Read from standard input |
| `--output <text\|json>` | Output format (default: `text`) |
| `--compat-level <100-160>` | SQL Server compatibility level |
| `--severity <error\|warning\|info\|hint>` | Minimum severity filter |
| `--preset <name>` | Preset selection |
| `--ruleset <path>` | Custom ruleset file |
| `--verbose` | Show detailed information (execution time) |
| `-q, --quiet` | Suppress informational stderr output (for IDE/extension integration) |

##### Default Command Behavior

When no subcommand is specified, `lint` is assumed. The following are equivalent:

```bash
tsqlrefine lint --stdin --output json
tsqlrefine --stdin --output json
```

##### Summary Output

After lint execution, a summary is always written to stderr:

```
3 problems (1 error, 2 warnings) in 5 files. 1 auto-fixable.
```

When no violations are found:

```
No problems found in 1 file.
```

With `--verbose`, execution time is additionally displayed:

```
No problems found in 5 files.
Time: 42ms
```

With `--quiet` (`-q`), all informational stderr output is suppressed. Only stdout diagnostics and the exit code remain. This is designed for IDE/extension integration where machine-readable output is consumed programmatically.

#### format

```
tsqlrefine format [options] [paths...]
```

| Option | Description |
|------------|------|
| `-g, --ignorelist <path>` | Ignore pattern file |
| `--detect-encoding` | Auto-detect input encoding |
| `--stdin` | Read from standard input |
| `--output <text\|json>` | Output format (default: `text`) |
| `--compat-level <100-160>` | SQL Server compatibility level |
| `--indent-style <tabs\|spaces>` | Indentation type |
| `--indent-size <n>` | Indentation width |
| `--line-ending <auto\|lf\|crlf>` | Line ending style |
| `-q, --quiet` | Suppress informational stderr output |

> **Note**: When files are specified, formatted results are automatically written to the files. When using standard input (`--stdin`), results are output to stdout.

Progress messages (`Formatted: file.sql` / `Unchanged: file.sql`) are written to stderr by default. Use `--quiet` to suppress them.

#### fix

```
tsqlrefine fix [options] [paths...]
```

| Option | Description |
|------------|------|
| `-g, --ignorelist <path>` | Ignore pattern file |
| `--detect-encoding` | Auto-detect input encoding |
| `--stdin` | Read from standard input |
| `--output <text\|json>` | Output format (default: `text`) |
| `--compat-level <100-160>` | SQL Server compatibility level |
| `--severity <error\|warning\|info\|hint>` | Minimum severity filter |
| `--preset <name>` | Preset selection |
| `--ruleset <path>` | Custom ruleset file |
| `--rule <id>` | Rule ID to apply |
| `-q, --quiet` | Suppress informational stderr output |

> **Note**: When files are specified, fixed results are automatically written to the files. When using standard input (`--stdin`), results are output to stdout.

Progress messages (`Fixed: file.sql (N fixes applied)` / `Unchanged: file.sql`) are written to stderr by default. Use `--quiet` to suppress them.

#### init

```
tsqlrefine init [options]
```

| Option | Description |
|------------|------|
| `--force` | Overwrite existing configuration files |
| `--preset <name>` | Preset ruleset to use (default: `recommended`) |
| `--compat-level <100-160>` | SQL Server compatibility level (default: `150`) |

Generates `tsqlrefine.json` and `tsqlrefine.ignore` in the current directory.

- The generated `tsqlrefine.json` includes a `$schema` reference for IDE autocompletion
- If configuration files already exist, returns an error with a hint to use `--force`
- Success messages are written to stdout

Example:

```bash
# Default initialization
tsqlrefine init

# Initialize with strict preset and SQL Server 2022
tsqlrefine init --preset strict --compat-level 160

# Overwrite existing configuration
tsqlrefine init --force
```

#### print-config

```
tsqlrefine print-config [options]
```

| Option | Description |
|------------|------|
| `--output <text\|json>` | Output format (default: `text`) |

#### print-format-config

```
tsqlrefine print-format-config [options] [paths...]
```

| Option | Description |
|------------|------|
| `--output <text\|json>` | Output format (default: `text`) |
| `--indent-style <tabs\|spaces>` | Indentation type |
| `--indent-size <n>` | Indentation width |
| `--line-ending <auto\|lf\|crlf>` | Line ending style |
| `--show-sources` | Show where each option value originated |

#### list-rules

```
tsqlrefine list-rules [options]
```

| Option | Description |
|------------|------|
| `--output <text\|json>` | Output format (default: `text`) |
| `--category <name>` | Filter rules by category |
| `--fixable` | Show only fixable rules |
| `--preset <name>` | Show enabled status for the specified preset |

Text output displays a formatted table:

```
Rule ID                                Category         Severity      Fixable
──────────────────────────────────────────────────────────────────────────────
avoid-select-star                      Performance      Warning       No
semantic/undefined-alias               Correctness      Error         No

Total: 101 rules
```

JSON output returns an array of rule objects:

```json
[
  {
    "id": "avoid-select-star",
    "description": "Avoid SELECT *; explicitly list required columns.",
    "category": "Performance",
    "defaultSeverity": "warning",
    "fixable": false,
    "minCompatLevel": 100,
    "maxCompatLevel": 160
  }
]
```

#### list-plugins

```
tsqlrefine list-plugins [options]
```

| Option | Description |
|------------|------|
| `--output <text\|json>` | Output format (default: `text`) |
| `--verbose` | Display detailed information |

### 2.3 Option Details

#### Preset (`--preset`)

| Preset | Description |
|------------|------|
| `recommended` | Balanced for production use (default) |
| `strict` | Maximum enforcement including style rules |
| `strict-logic` | Comprehensive correctness without cosmetic rules |
| `pragmatic` | Production minimum (bug and data loss prevention) |
| `security-only` | Security and critical safety only |

When an unknown preset name is specified, the error message lists available presets:

```
Unknown preset: 'foo'. Available presets: pragmatic, recommended, security-only, strict, strict-logic
```

#### Encoding Detection (`--detect-encoding`)

- BOM takes priority. If no BOM, estimation via `UTF.Unknown`
- Without `--detect-encoding`, **reading** interprets as UTF-8
- For `format` / `fix`, input file encoding (including BOM presence) is preserved regardless of `--detect-encoding`

#### Formatting

- Respects `.editorconfig` `indent_style` / `indent_size` (`*.sql` only)
- `--indent-style` / `--indent-size` take precedence over `.editorconfig`
- Invariant regions: **comments / strings / line breaks within parentheses are not modified**

#### fix / format Command Output

- File input: results are automatically written to the file
- `--stdin` input: results are output to stdout
- With `--output json`: only diagnostic results are output

---

## 3. Text Output Format

For `--output text` (default), diagnostics are output in the following format:

```
<filepath>:<line>:<column>: <severity>: <message> (<rule-id>[,Fixable])
```

Example:

```
file.sql:1:8: Warning: Avoid SELECT *; explicitly list required columns. (avoid-select-star)
file.sql:1:15: Warning: Table reference 'users' should include schema qualification. (semantic/schema-qualify)
file.sql:3:1: Warning: Use uppercase for SQL keywords. (keyword-casing,Fixable)
```

- `<filepath>`: File path (`<stdin>` for stdin)
- `<line>`: Line number (1-based)
- `<column>`: Column number (1-based)
- `<severity>`: `Error` / `Warning` / `Information` / `Hint`
- `<message>`: Diagnostic message
- `<rule-id>`: Rule ID
- `,Fixable`: Appended when the violation is auto-fixable

This format is similar to ESLint / GCC / rustc and is recognized as clickable links in many editors and IDEs.

---

## 4. JSON Output Specification (Diagnostics)

Based on VSCode `Diagnostic` compatible format, bundled by file.

### 4.1 Top Level

```ts
interface LintResult {
  tool: "tsqlrefine";
  version: string;
  command: "lint" | "format" | "fix";
  files: FileResult[];
}

interface FileResult {
  filePath: string;              // "<stdin>" for stdin
  diagnostics: Diagnostic[];
}
```

### 4.2 Diagnostic (0-based)

```ts
interface Diagnostic {
  range: Range;
  severity?: DiagnosticSeverity; // defaults to rule's defaultSeverity
  code?: number | string;        // Rule ID (e.g., "semantic/undefined-alias")
  source?: string;               // "tsqlrefine"
  message: string;
  tags?: DiagnosticTag[];
  data?: {
    ruleId?: string;
    category?: string;
    fixable?: boolean;
  };
}

interface Range {
  start: Position;
  end: Position;
}

interface Position {
  line: number;      // 0-based
  character: number; // 0-based
}

enum DiagnosticSeverity {
  Error = 1,
  Warning = 2,
  Information = 3,
  Hint = 4
}

enum DiagnosticTag {
  Unnecessary = 1,
  Deprecated = 2
}
```

---

## 5. Exit Codes

Fixed exit codes by result type for easy CI handling.

- `0`: Success (0 diagnostics, or 0 after `--severity` filter)
- `1`: Rule violations found (diagnostics present)
- `2`: Parse error (unparseable, `GO` split failure, etc.)
- `3`: Configuration error (config/ignore load failure, invalid compatibility level, etc.)
- `4`: Runtime exception (internal error)

For `format`/`fix`, if parse errors occur during processing, exit code is `2`.

---

## 6. IDE / Extension Integration

For integration from VS Code extensions or other tools, use `--quiet` (`-q`) with `--output json`:

```bash
# Lint with JSON output, no stderr noise
tsqlrefine lint --stdin --output json -q

# Fix via stdin, no progress messages
tsqlrefine fix --stdin -q

# Format via stdin, no progress messages
tsqlrefine format --stdin -q
```

With `--quiet`:
- **stdout**: Contains only data output (diagnostics in text/JSON format, or formatted/fixed SQL for stdin)
- **stderr**: Empty (informational messages suppressed). Error messages (config errors, "No input") are still emitted
- **Exit code**: Unchanged (0/1/2/3/4)

This ensures clean machine consumption without needing to filter stderr.
